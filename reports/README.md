# Результаты экспериментов

Сначала были проведены дополнительные экспермиенты по изменению гиперпараметров, замены функции потерь, изменению оптимизаторов. В основном все эксперименты проводились для датасета **torchgeo**, учитывая маленький размер видеокарты, набор параметров по умолчанию представлен ниже:

| Название          | Значение | Примечание                                                  |
|----------:        |:--------:|:--------:                                                   |
| **batch_size**    | 8        | Подбирался исходя из размеров памяти видеокарты             |
| **img_size**      | 256      | Подбирался исходя из размеров памяти видеокарты             | 
| **iou_thr**       | 0.5      | Смотри эксперимент 1                                        |
| **loss_fns**      | DiceLoss | Смотри эксперимент 3                                        |
| **model_epoch**   | 30       | Смотри эксперимент 2                                        |
| **model_lr**      | 0.0001   | |
| **optimizer**     | Adam     | |
| **train_samp_len**| 640      | Бралась примерно половина от максимально возможно количества|
| **val_samp_len**  | 320      | Бралась примерно половина от максимально возможно количества|


1. Изменение гиперпараметра **IoU threshold**

<a href="/reports/clearml_screens/clearml_1.png"><img src="/reports/clearml_screens/clearml_1.png" style="width: 500px; max-width: 100%; height: auto" title="Click for the larger version." /></a>

Как видно из графиков данный параметр не влияет на метрики и функции потерь.


2. Изменение **количества эпох**

<a href="/reports/clearml_screens/clearml_2.png"><img src="/reports/clearml_screens/clearml_2.png" style="width: 500px; max-width: 100%; height: auto" title="Click for the larger version." /></a>

Как видно из графиков увеличение обучения не влияет на увеличение метрики или уменьшение функции потерь.

3. Изменение **функции потерь**

<a href="/reports/clearml_screens/clearml_3.png"><img src="/reports/clearml_screens/clearml_3.png" style="width: 500px; max-width: 100%; height: auto" title="Click for the larger version." /></a>

Как видно из графиков функция потерь Dice принимает меньшие значения, поэтому она принята за базовую.

4. Изменение **оптимизаторов**

<a href="/reports/clearml_screens/clearml_4.png"><img src="/reports/clearml_screens/clearml_4.png" style="width: 500px; max-width: 100%; height: auto" title="Click for the larger version." /></a>

Как видно из графиков оптимизаторы для данной задачи примерно одинаковы, базовым возьмем **Lion**, так как он самый "свежий".

# Главный эксперимент

**Классический подход VS torchgeo**

1. Сначала результаты "не правильного" эксперимента. По значениям метрики и функции потерь выиграл - Классический подход. Так как в основном все значения одинаковые, а различия только в размере подаваемых изображений **512 vs 256** (классический подход и torchgeo), то скорее всего  нужно увеличить размер изображения для **torchgeo** подхода (так как судя по всему большее изображение дает большее кол-во признаков и паттернов для сегментации борщевика). 

<a href="/reports/clearml_screens/clearml_5.png"><img src="/reports/clearml_screens/clearml_5.png" style="width: 500px; max-width: 100%; height: auto" title="Click for the larger version." /></a>

С точки зрения логики в **torchgeo** мы подаем "большее" количество данных, за счет 2 дополнительных слоев, поэтому и результат должен быть лучше классического подхода. Посмотрим на это в следующем эксперименте.


2. Результат "правильного" эксперимента, при равных размерах картинок. Представлен ниже. Результат не тот, который ожидали. Единственное предположение, в разных наборах данных. То есть если для **классического подхода** разбиение на подвыборки train & val было **случайным**, то для подхода **torchgeo**, для валидационной подвыборки взялся **правый вертикальный** прямоугольник равный 30% от общей площади. И в этом валидационном "куске" находится большое количество пикселей положительного класса. Поэтому модель **torchgeo** справляется хуже со своим набором валидации, чем классический подход. Потому что он "сложнее", если можно так выразится. 

<a href="/reports/clearml_screens/clearml_6.png"><img src="/reports/clearml_screens/clearml_6.png" style="width: 500px; max-width: 100%; height: auto" title="Click for the larger version." /></a>

*(Описаное выше - субъективное мнение, Вы можете проверить собственноручно данное предположение)*

**Примечание**: Еще один момент, который был упущен из виду. Это то, что при помощи **torchgeo** мы можем подавать все данные без исключения, а в классическом случае, если размер спутникового снимка не делиться **нацело** на размер подаваемого мини-изображения в модель при обучении, то придется или "удалять обрезки", или придумывать "велосипед" с дорисовкой обрезкам недостоющих зон(к примеру заполнение нулями недостоющих пикселей).

В нашем проекте пришлось удалить часть обрезков (около 10%), так как торч ругается на них 8(

<a href="/references/helpers/проблема размерности картинок.png"><img src="/references/helpers/проблема размерности картинок.png" style="width: 500px; max-width: 100%; height: auto" title="Click for the larger version." /></a>


# Вывод
В нашем проекте **torchgeo** подход не смог превзойти по значениям метрики классический подход, но это не значит, что инструментарий данной библиотеки "плох". Он хорош для своих целей, надеюсь в будущем данная библиотека станет еще лучше и удобней для исследования спутниковых данных.

Итоговая таблица, всех проведенных экспериментов, представлена ниже.

| Модель       | Подход | Loss Fn | Optim | Batch_size | Img_size | Epoch | IoU thr | IoU val |
|----------:   |:------:|:------: |:-----:|:----------:|:--------:|:-----:|:-------:|:-------:|
| **DeepLabv3**|torch   |dice     |Adam   |2           |512       |30     |0.5      |0.5846   |
| **FCN**      |torch   |dice     |Lion   |2           |512       |30     |0.5      |0.564    |
| **FCN**      |torch   |dice     |Adam   |2           |512       |30     |0.5      |0.5400   |
| **DeepLabv3**|torchgeo|dice     |Adam   |8           |256       |30     |0.8      |0.4326   |
| **DeepLabv3**|torchgeo|dice     |Adam   |8           |256       |30     |0.5      |0.4248   |
| **DeepLabv3**|torchgeo|jaccard  |Adam   |8           |256       |30     |0.5      |0.4137   |
| **DeepLabv3**|torchgeo|dice     |AdamW  |8           |256       |30     |0.5      |0.4084   |
| **DeepLabv3**|torchgeo|dice     |Adam   |8           |256       |50     |0.5      |0.3914   |
| **DeepLabv3**|torchgeo|dice     |Adam   |8           |256       |30     |0.2      |0.3886   |
| **DeepLabv3**|torchgeo|dice     |Lion   |2           |512       |30     |0.5      |0.3847   |
| **DeepLabv3**|torchgeo|dice     |Lion   |8           |256       |30     |0.5      |0.3824   |
| **DeepLabv3**|torchgeo|dice     |Lion   |8           |256       |60     |0.5      |0.3405   |
| **DeepLabv3**|torchgeo|dice     |Adam   |2           |512       |30     |0.5      |0.3161   |



Вдохновение для данного проекта черпалось из [работы](https://towardsdatascience.com/artificial-intelligence-for-geospatial-analysis-with-pytorchs-torchgeo-part-3-7521131f30b1) [Maurício Cordeiro](https://www.linkedin.com/in/cordmaur/). За что ему огромное спасибо.

P.S. В его работе - значения метрик после обучения через **torchgeo** сравнялись со значениями метрик после обучения классическим способом, только значения гиперпараметров не подбирались в первом случае.